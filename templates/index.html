<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #070514;
            color: #abb2b0;
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Downloader</title>
</head>
<body>
    <h1>Flow-Fetch Universal downloader</h1>
    <p>Download videos from YouTube, Facebook, Instagram, Twitter, Vimeo, Dailymotion, and many more.</p>
    <p>Just paste the URL and download the video in any format you want.</p>
    <p>It's free, fast, and easy to use.</p>
    <input type="text" id="youtube-url" placeholder="Paste YouTube link here">
    <button onclick="fetchVideoInfo()">Check Video</button>

    <div id="video-info" style="display: none;">
        <h3 id="video-title"></h3>
        <p id="video-author"></p>
        <img id="video-thumbnail" src="" alt="Thumbnail">
        
        <h4>Choose Resolution</h4>
        <select id="resolution-select"></select>
        <button onclick="downloadVideo()">Download</button>
    </div>

    <script>
        let videoData = {};  // Store video details

        async function fetchVideoInfo() {
            const url = document.getElementById("youtube-url").value;
            const videoID = extractYouTubeID(url);
            if (!videoID) {
                alert("Invalid YouTube URL");
                return;
            }

            try {
                // Get video info using oEmbed
                const oEmbedResponse = await fetch(`https://www.youtube.com/oembed?url=${url}&format=json`);
                if (!oEmbedResponse.ok) throw new Error("Invalid YouTube URL");
                const oEmbedData = await oEmbedResponse.json();

                // Generate potential resolutions
                const resolutions = {
                    "144p": `https://img.youtube.com/vi/${videoID}/default.jpg`,
                    "240p": `https://img.youtube.com/vi/${videoID}/mqdefault.jpg`,
                    "360p": `https://img.youtube.com/vi/${videoID}/hqdefault.jpg`,
                    "480p": `https://img.youtube.com/vi/${videoID}/sddefault.jpg`,
                    "720p": `https://img.youtube.com/vi/${videoID}/maxresdefault.jpg`
                };

                // Check available thumbnails (to determine available resolutions)
                const availableResolutions = {};
                for (const [res, imgUrl] of Object.entries(resolutions)) {
                    const response = await fetch(imgUrl, { method: "HEAD" });
                    if (response.ok) availableResolutions[res] = imgUrl;
                }

                // Store video data
                videoData = {
                    url: url,
                    title: oEmbedData.title,
                    author: oEmbedData.author_name,
                    thumbnail: Object.values(availableResolutions).pop(), // Highest available thumbnail
                    resolutions: Object.keys(availableResolutions)
                };

                // Update UI
                document.getElementById("video-title").innerText = videoData.title;
                document.getElementById("video-author").innerText = `By: ${videoData.author}`;
                document.getElementById("video-thumbnail").src = videoData.thumbnail;
                
                // Populate resolution options
                const resolutionSelect = document.getElementById("resolution-select");
                resolutionSelect.innerHTML = "";
                videoData.resolutions.forEach(res => {
                    const option = document.createElement("option");
                    option.value = res;
                    option.innerText = res;
                    resolutionSelect.appendChild(option);
                });

                document.getElementById("video-info").style.display = "block";

            } catch (error) {
                alert("Error fetching video info: " + error.message);
            }
        }

        function extractYouTubeID(url) {
            const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
            return match ? match[1] : null;
        }

        async function downloadVideo() {
            const selectedResolution = document.getElementById("resolution-select").value;
            const formatType = "video";

            // Send request to FastAPI backend
            const response = await fetch("/download", {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    url: videoData.url, 
                    resolution: selectedResolution,
                    format_type: formatType,
                })
            });

            if (response.ok) {
                const blob = await response.blob();
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = videoData.title.replace(/[^a-z0-9]/gi, '_') + ".mp4";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert("Download failed!");
                console.error(response);
            }
        }
    </script>
</body>
</html>
